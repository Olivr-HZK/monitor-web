# 登录与后端部署说明

本站支持三种方式：

1. **仅静态**：无登录，直接看内容（如 GitHub Pages 默认）。
2. **静态 + 访问密码**：仍是纯静态部署，但需输入「访问密码」后才显示内容（见下文）。
3. **带登录后端**：用户名+密码，数据通过接口鉴权。

---

## 静态页面也能登录：访问密码（无后端）

在**不跑后端**、只部署静态资源（如 GitHub Pages）时，也可以加一道「访问密码」门控：打开页面先看到登录框，输入正确密码后才显示内容。

### 方式一：用配置文件（推荐，部署后必生效）

项目里已有 **`public/auth-config.json`**，里面写好了访问密码的哈希。只要该文件在 `public/` 下并参与部署，静态站就会先出登录框。

1. **改密码时**：生成新哈希并更新该文件：
   ```bash
   node scripts/hash-static-password.js 你的新密码
   ```
   把输出的哈希填进 **`public/auth-config.json`** 的 `staticPasswordHash` 字段，例如：
   ```json
   {
     "staticPasswordHash": "98a575ea798bafc8fc1d9f8d4c47a315bbd09a2e463da9f4e4967fe28e799f07"
   }
   ```

2. **重新构建并部署**：
   ```bash
   npm run build
   npm run deploy
   ```

### 方式二：用 .env（构建时注入）

1. 在项目根目录执行：
   ```bash
   node scripts/hash-static-password.js 你的访问密码
   ```
2. 把输出那一行写入**项目根目录**的 **`.env`**（没有就新建）：
   ```env
   VITE_STATIC_PASSWORD_HASH=一长串十六进制
   ```
3. **先保存 .env，再**执行：
   ```bash
   npm run build
   npm run deploy
   ```

**优先级**：若存在 `auth-config.json` 且其中有 `staticPasswordHash`，会优先用该值；否则才用 `.env` 里构建时注入的 `VITE_STATIC_PASSWORD_HASH`。

之后访问静态站会先出现「访问密码」输入框，输入正确密码后即可进入；同一标签页内会保持已解锁状态（关闭标签页后需重新输入）。

**说明**：密码只在浏览器内与哈希比对，不经过服务器，因此无法防止懂技术的人通过查看前端代码或配置文件绕过。适合「不想被随便看到、但不涉及敏感数据」的轻量保护。

---

## 一、本地开发（前端 + 后端）

### 1. 配置登录账号（仅首次）

```bash
cd server
npm install
node hash-password.js 你的密码
```

把终端输出的 `LOGIN_PASSWORD_HASH=...` 写入 `server/.env`，并补全：

```env
PORT=3001
JWT_SECRET=请改为随机长字符串
LOGIN_USERNAME=admin
LOGIN_PASSWORD_HASH=刚才生成的哈希
```

（不配置 `LOGIN_PASSWORD_HASH` 时，本地会进入「仅校验用户名、任意密码」的简易模式，仅适合开发。）

### 2. 启动后端

```bash
npm run dev:server
```

后端会在 http://localhost:3001 启动。

### 3. 启动前端（另开终端）

```bash
npm install
npm run dev
```

前端在 http://localhost:5173，请求会通过 Vite 代理到 3001 的 `/api`。

在浏览器打开 http://localhost:5173，用 `server/.env` 里的用户名和密码登录后即可访问内容。

---

## 二、生产部署（带登录的后端）

1. **构建前端（根路径，供同一域名下后端托管）**

   ```bash
   VITE_BASE=/ npm run build
   ```

2. **配置 `server/.env`**（同上，务必设置 `LOGIN_PASSWORD_HASH` 和安全的 `JWT_SECRET`）。

3. **启动服务**

   ```bash
   node server/server.js
   ```

   或使用进程管理（如 pm2）：

   ```bash
   pm2 start server/server.js --name monitor-web
   ```

4. 将域名或公网 IP 指到该机器对应端口（如 80 → 3001 或通过 Nginx 反代）。

访问站点会先到登录页，登录成功后即可查看监测内容；Header 右侧会显示当前用户名和「退出」按钮。

---

## 三、仅静态部署（无登录）

不启动后端、仅部署前端（如 GitHub Pages）时：

- 打开页面不会出现登录，直接使用静态数据（相对路径加载 `public/` 下的文件）。
- 若当前环境没有 `/api/me`（例如 404），前端会自动识别为「静态模式」，不展示登录页。

---

## 四、安全建议

- 生产环境务必设置强 `JWT_SECRET` 和安全的 `LOGIN_PASSWORD_HASH`。
- 不要将 `server/.env` 提交到 Git（已加入 `.gitignore`）。
- 若对外提供 HTTPS，建议在 Express 前加 Nginx 做反向代理与 TLS。
